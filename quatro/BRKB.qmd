---
title: "Berkshire analysis"
author: "Wouter Buitenhuis"
format: pdf
editor: visual
---

## Intro

Key questions I want to address:

-   How is the insurance business doing:

    -   How does the profit margin evolve?
    -   What is the (long term) growth rate of profits?
    -   How do underwriting expenses evolve?
    -   What has been driving changes in profits? Changes in underwriting expenses, premium rates, or more business?

-   How is the railway business doing:

    -   How does the profit margin evolve?
    -   What is the long term growth rate of profits?
    -   What drive changes in profits? Is it driven by profit margin, or overall growth of the business?

-   How is the energy business doing?

    -   How does the profit margin evolve?
    -   What is the long term growth rate of profits?
    -   What drive changes in profits? Is it driven by profit margin, or overall growth of the business?

-   Does the amount of buybacks of Berkshire be a predictor of future profitability or share price?

-   Does amount of cash relative to total investments predict stock market?

-   What is the expected profit growth rate for all operational business going forward?

-   If you back out the public investments is Berkshire priced attractive?

```{r}
#| echo: false
#| warning: false
#| message: false
library(xts)
library(ggplot2)
load("../data/BRKB_income_bu.Rdata")
data <- data3M
data_graph <- data.frame(date = index(data), data)
data_graph$t <- round((as.numeric(index(data) - last(index(data)))) / 365.25, digits = 2)

```

## Graphs

```{r}
#| echo: false
#| warning: false
#| message: false
 # plot((data$InsPremiumsEarned - data$InsUnderwritingExpenses),
 #      yaxis.right = FALSE,
 #      main = "Premiums - underwriting expenses",
 #      main.timespan = FALSE)
ols_premiums <- lm(log(InsPremiumsEarned - InsUnderwritingExpenses) ~ t, data = data_graph)
caption <- paste("ln[premiums - underwriting expenses] =", 
                 round(coef(ols_premiums)[1],1), "+", round(coef(ols_premiums)[2],3), "t")
 data_graph |> ggplot(aes(x = date, 
                          y = log10(InsPremiumsEarned - InsUnderwritingExpenses))) +
   geom_point() + 
  geom_line() +
   scale_x_date(
    breaks = seq(min(data_graph$date), max(data_graph$date), by = "5 year"),
    minor_breaks = seq(min(data_graph$date), max(data_graph$date), by = "year"),
    date_labels = "%Y") + 
   scale_y_continuous(
    name = "10 Log $",                      # Primary y-axis label
    sec.axis = sec_axis(~ 10^(.),             # Transformation for the secondary y-axis
                        name = "$") ) +  # Secondary y-axis label
     labs(title = "Premiums - underwriting expenses", x = "",
    y = "billion $",
    caption = caption) +
   geom_smooth(method = "lm",           # Add OLS fit
              se = TRUE,               # Display confidence interval (optional)
              color = "darkred") +  
  theme(axis.text.x = element_text(angle = 70, hjust = 1)) + 
   theme_minimal() 
  
 ols_ins_exp_ratio <- lm(InsUnderwritingExpenses / InsPremiumsEarned ~ t, data = data_graph)
 caption <- paste("underwriting expenses / premiums =", 
                 round(coef(ols_ins_exp_ratio)[1],3), "+", round(coef(ols_ins_exp_ratio)[2],4), "t")
 data_graph |> ggplot(aes(x = date, 
                          y = InsUnderwritingExpenses / data$InsPremiumsEarned)) +
   geom_point() + 
  geom_line() +
   scale_x_date(
    breaks = seq(min(data_graph$date), max(data_graph$date), by = "5 year"),
    minor_breaks = seq(min(data_graph$date), max(data_graph$date), by = "year"),
    date_labels = "%Y") + 
   scale_y_continuous(
    name = "expense ratio") +  # Secondary y-axis label
     labs(title = "Insurance underwriting expense ratio", x = "",
    y = "",
    caption = caption) +
   geom_smooth(method = "lm",           # Add OLS fit
              se = TRUE,               # Display confidence interval (optional)
              color = "darkred") +  
  theme(axis.text.x = element_text(angle = 70, hjust = 1)) + 
   theme_minimal() 
  
  plot(data$InsPremiumsEarned - data$InsUnderwritingExpenses - data$ClaimsPropertyLiability - data$PolicyHolderBenefits,
            yaxis.right = FALSE,
      main = "Insurance Gross Profits",
      main.timespan = FALSE)

ols_ins_profit <- lm((InsPremiumsEarned - InsUnderwritingExpenses - ClaimsPropertyLiability- PolicyHolderBenefits)/ 10^9 ~ t, data = data_graph)
caption <- paste("profits =", 
                 round(coef(ols_ins_profit)[1],4), "+", round(coef(ols_ins_profit)[2],4), "t")
 data_graph |> ggplot(aes(x = date, 
                          y = (InsPremiumsEarned - InsUnderwritingExpenses - ClaimsPropertyLiability - PolicyHolderBenefits)/ 10^9)) +
   geom_point() + 
  geom_line() +
   scale_x_date(
    breaks = seq(min(data_graph$date), max(data_graph$date), by = "5 year"),
    minor_breaks = seq(min(data_graph$date), max(data_graph$date), by = "year"),
    date_labels = "%Y") + 
#   scale_y_continuous(
#    name = "$",                      # Primary y-axis label
#    sec.axis = sec_axis(~ 10log(.),             # Transformation for the secondary y-axis
#                        name = "10 log") ) +  # Secondary y-axis label
     labs(title = "Insurance profits", x = "",
    y = "billion $",
    caption = caption) +
   geom_smooth(method = "lm",           # Add OLS fit
              se = TRUE,               # Display confidence interval (optional)
              color = "darkred") +  
  theme(axis.text.x = element_text(angle = 70, hjust = 1)) + 
   theme_minimal() 
    
    
  plot(data$LeaseIncome - data$CostOfLeasing,
            yaxis.right = FALSE,
      main = "Leasing Gross Profits",
      main.timespan = FALSE)
  
  plot(data$LeaseIncome/data$CostOfLeasing - 1,
            yaxis.right = FALSE,
      main = "Leasing Profit Margin",
      main.timespan = FALSE)
  
  plot(data$ServiceRevenue - data$CostOfServices,
            yaxis.right = FALSE,
      main = "Service Gross Profits",
      main.timespan = FALSE)
  plot(data$ServiceRevenue / data$CostOfServices - 1,
       yaxis.right = FALSE,
      main = "Service Profit Margin",
      main.timespan = FALSE)
  
  plot(data$FreightRevenue - data$FreightCosts,
            yaxis.right = FALSE,
      main = "Freight Gross Profits",
      main.timespan = FALSE)

  plot(data$FreightRevenue / data$FreightCosts -1,
            yaxis.right = FALSE,
      main = "Freight Profit Margin",
      main.timespan = FALSE)
  plot(data$EnergyRevenue - data$EnergyCosts,
            yaxis.right = FALSE,
      main = "Energy Gross Profits",
      main.timespan = FALSE)
  plot(data$EnergyRevenue / data$EnergyCosts - 1,
            yaxis.right = FALSE,
      main = "Energy Profit Margin",
      main.timespan = FALSE)
```

Balance sheet and cashflow statement gices the folowing graphs:
```{r}
#| echo: false
#| warning: false
#| message: false
library(xts)
library(ggplot2)

  plot(data$PnL + data$depreciation - data$plant_and_equipment,
            yaxis.right = FALSE,
      main = "Free cashflow",
      main.timespan = FALSE)

```